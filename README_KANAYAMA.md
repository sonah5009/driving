# 자율주행 AI 칩 설계 - Driving 시스템 (Kanayama 제어기 통합)

## 개요

이 시스템은 YOLOv3-Tiny 모델을 사용하여 차선을 탐지하고, Kanayama 제어기를 통해 정교한 차선 추종을 수행하는 자율주행 시스템입니다.

## 주요 기능

### 1. 이중 제어 알고리즘 지원
- **Kanayama 제어기**: 좌우 차선 정보를 모두 활용한 정교한 제어
- **기존 방식**: 오른쪽 차선만을 이용한 단순한 제어 (하위 호환성)

### 2. 실시간 차선 탐지
- YOLO 모델을 통한 실시간 차선 탐지
- 좌우 차선 구분 및 기울기 계산
- 바운딩 박스 시각화

### 3. 모드 전환 기능
- 자율주행 모드 / 수동주행 모드
- 제어 알고리즘 실시간 전환

## 시스템 구조

```
driving/
├── main.py                      # 메인 실행 파일
├── driving_system_controller.py # 시스템 제어기
├── image_processor.py           # 이미지 처리 및 Kanayama 제어기
├── motor_controller.py          # 모터 제어
├── yolo_utils.py               # YOLO 모델 유틸리티
├── config.py                   # 설정 파일
└── AutoLab_lib.py              # 하드웨어 라이브러리
```

## 설치 및 실행

### 1. 의존성 설치
```bash
pip install opencv-python numpy pynq pynq-dpu keyboard
```

### 2. 모델 파일 준비
- `../xmodel/top-tiny-yolov3_coco_256.xmodel`: YOLO 모델 파일
- `../xmodel/lane_class.txt`: 클래스 정의 파일

### 3. 실행
```bash
cd Autonomous-Driving-AI-Chip-Design/driving
python main.py
```

## 사용법

### 키보드 제어

| 키 | 기능 |
|---|---|
| `1` | 자율주행 모드 전환 |
| `2` | 수동주행 모드 전환 |
| `K` | 제어 알고리즘 전환 (Kanayama ↔ 기존 방식) |
| `Space` | 주행 시작/정지 |
| `Q` | 프로그램 종료 |

### 수동 주행 모드에서 추가 제어

| 키 | 기능 |
|---|---|
| `W` | 전진 |
| `S` | 후진 |
| `A` | 좌회전 |
| `D` | 우회전 |
| `R` | 긴급 정지 |

## Kanayama 제어기 파라미터 조정

`config.py` 파일에서 다음 파라미터들을 조정할 수 있습니다:

```python
KANAYAMA_CONFIG = {
    'K_y': 1.0,        # 횡방향 오차 게인 (높을수록 강한 보정)
    'K_phi': 3.0,      # 방향각 오차 게인 (높을수록 강한 보정)
    'L': 0.5,          # 휠베이스 (m) - 차량 물리적 특성
    'lane_width': 3.5, # 차선 폭 (m) - 도로 환경
    'v_r': 30.0        # 기준 속도
}
```

### 파라미터 튜닝 가이드

1. **K_y (횡방향 게인)**
   - 너무 높으면: 진동 발생
   - 너무 낮으면: 차선 이탈
   - 권장 범위: 0.5 ~ 2.0

2. **K_phi (방향각 게인)**
   - 너무 높으면: 급격한 방향 변화
   - 너무 낮으면: 곡선 주행 어려움
   - 권장 범위: 2.0 ~ 5.0

3. **lane_width (차선 폭)**
   - 실제 도로의 차선 폭에 맞게 설정
   - 일반 도로: 3.5m, 고속도로: 3.75m

## 차선 탐지 로직

### 1. 이미지 전처리
- Bird's eye view 변환
- ROI (관심 영역) 추출
- 256x256 크기로 리사이즈

### 2. YOLO 모델 추론
- DPU를 통한 고속 추론
- 바운딩 박스 좌표 추출

### 3. 차선 정보 추출
- 이미지 중앙 기준 좌우 차선 분류
- 차선 기울기 계산
- 가장 적절한 차선 선택

### 4. Kanayama 제어
- 횡방향 오차 계산
- 방향각 오차 계산
- 조향각 계산 및 제한

## 디버깅 정보

실행 중 다음 정보들이 출력됩니다:

```
Left: x=85.2, slope=0.023
Right: x=170.8, slope=-0.015
Steering angle: 2.45°
```

## 문제 해결

### 1. 차선을 찾을 수 없는 경우
- 카메라 각도 조정
- 조명 조건 개선
- 모델 재학습 고려

### 2. 주행이 불안정한 경우
- K_y, K_phi 값 낮추기
- 속도(v_r) 조정
- 차선 폭 설정 확인

### 3. 곡선 주행이 어려운 경우
- K_phi 값 높이기
- 차선 탐지 정확도 개선
- 모델 성능 향상

## 성능 최적화

1. **DPU 활용**: 하드웨어 가속을 통한 실시간 처리
2. **ROI 설정**: 불필요한 영역 제거로 처리 속도 향상
3. **파라미터 튜닝**: 환경에 맞는 최적 파라미터 설정

## 라이센스

본 프로그램은 2025 제8회 국민대 자율주행 경진대회 예선과제 수행용으로만 사용 가능하며 외부 유출은 금지됩니다. 